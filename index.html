<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EstadÃ­sticas Mercadona</title>
  
  <!-- CSS Modules -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/tabs.css">
  <link rel="stylesheet" href="css/themes.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    
    <!-- Header -->
    <header class="header">
      <div>
        <h1>ğŸ›’ EstadÃ­sticas Mercadona</h1>
        <p id="periodInfo">Cargando...</p>
      </div>
      <div class="filters">
        <div class="filter-group">
          <label for="storeFilter">ğŸª Tienda:</label>
          <select id="storeFilter">
            <option value="all">Todas</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="yearFilter">ğŸ“… AÃ±o:</label>
          <select id="yearFilter">
            <option value="all">Todos</option>
          </select>
        </div>
        <button class="icon-btn" id="darkModeToggle" title="Modo oscuro">ğŸŒ™</button>
        <button class="icon-btn" id="exportBtn" title="Exportar datos">ğŸ“¥</button>
        <button class="icon-btn" id="reloadDataBtn" title="Cargar otros datos">ğŸ“‚</button>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="tabs">
      <button class="tab-btn active" data-tab="overview">
        <span class="tab-icon">ğŸ“Š</span> Resumen
      </button>
      <button class="tab-btn" data-tab="categories">
        <span class="tab-icon">ğŸ·ï¸</span> CategorÃ­as
      </button>
      <button class="tab-btn" data-tab="products">
        <span class="tab-icon">ğŸ“¦</span> Productos
      </button>
      <button class="tab-btn" data-tab="prices">
        <span class="tab-icon">ğŸ“ˆ</span> Precios
      </button>
      <button class="tab-btn" data-tab="tickets">
        <span class="tab-icon">ğŸ§¾</span> Tickets
      </button>
      <button class="tab-btn" data-tab="insights">
        <span class="tab-icon">ğŸ’¡</span> Insights
      </button>
    </nav>

    <!-- ==================== OVERVIEW TAB ==================== -->
    <section id="overviewTab" class="tab-content active">
      
      <!-- Stats Cards -->
      <div class="grid">
        <div class="card">
          <h3>ğŸ’° Total Gastado</h3>
          <div class="value blue" id="totalSpent">-</div>
          <div class="subtitle" id="totalSpentPeriod"></div>
        </div>
        <div class="card">
          <h3>ğŸ§¾ Total Tickets</h3>
          <div class="value green" id="ticketCount">-</div>
          <div class="subtitle" id="avgDaysBetween"></div>
        </div>
        <div class="card">
          <h3>ğŸ“Š Media por Ticket</h3>
          <div class="value purple" id="avgTicket">-</div>
          <div class="subtitle" id="ticketRange"></div>
        </div>
        <div class="card">
          <h3>ğŸ“… Media Mensual</h3>
          <div class="value orange" id="avgMonth">-</div>
          <div class="subtitle" id="monthComparison"></div>
        </div>
        <div class="card">
          <h3>ğŸª Tienda mÃ¡s visitada</h3>
          <div class="value" id="topStore">-</div>
          <div class="subtitle" id="topStoreCount"></div>
        </div>
        <div class="card">
          <h3>ğŸ“† DÃ­a favorito</h3>
          <div class="value" id="favoriteDay">-</div>
          <div class="subtitle" id="favoriteDayCount"></div>
        </div>
      </div>

      <!-- Comparison Cards -->
      <div class="comparison-section" id="comparisonSection">
        <h3>ğŸ“Š Comparativa con perÃ­odo anterior</h3>
        <div class="grid grid-3" id="comparisonCards"></div>
      </div>

      <!-- Monthly Chart -->
      <div class="chart-container">
        <h3>ğŸ“Š Gasto por Mes</h3>
        <div class="chart-wrapper">
          <canvas id="monthlyChart"></canvas>
        </div>
        <div id="monthlySummary"></div>
      </div>

      <!-- Weekly Pattern -->
      <div class="chart-container">
        <h3>ğŸ“… PatrÃ³n Semanal de Compras</h3>
        <div class="chart-wrapper small">
          <canvas id="weeklyChart"></canvas>
        </div>
      </div>

    </section>

    <!-- ==================== CATEGORIES TAB ==================== -->
    <section id="categoriesTab" class="tab-content">
      
      <div class="grid grid-2">
        <!-- Category Chart -->
        <div class="chart-container">
          <h3>ğŸ·ï¸ DistribuciÃ³n por CategorÃ­a</h3>
          <div class="chart-wrapper">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>
        
        <!-- Category List -->
        <div class="chart-container">
          <h3>ğŸ“‹ Detalle por CategorÃ­a</h3>
          <div class="category-list" id="categoryList">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>
      </div>

      <!-- Monthly Category Chart -->
      <div class="chart-container">
        <h3>ğŸ“… Gasto por Mes y CategorÃ­a</h3>
        <div class="chart-wrapper" style="height: 400px;">
          <canvas id="categoryMonthlyChart"></canvas>
        </div>
      </div>

      <!-- Products by Category -->
      <div class="chart-container">
        <h3>ğŸ“¦ Productos por CategorÃ­a
          <select id="categoryProductFilter" class="inline-select">
            <option value="all">Todas las categorÃ­as</option>
          </select>
          <select id="monthProductFilter" class="inline-select">
            <option value="all">Todos los meses</option>
          </select>
        </h3>
        <div id="categoryProductList">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>

    </section>

    <!-- ==================== PRODUCTS TAB ==================== -->
    <section id="productsTab" class="tab-content">
      
      <!-- Search -->
      <div class="chart-container">
        <h3>ğŸ” Buscar Producto</h3>
        <div class="search-box">
          <input type="text" id="productSearch" placeholder="Buscar producto...">
        </div>
        <div id="searchResults" class="product-list"></div>
      </div>

      <!-- Top Products Chart -->
      <div class="chart-container">
        <h3>ğŸ† Top 10 Productos por Gasto
          <select id="topProductsSort" class="inline-select">
            <option value="spent">Por gasto total</option>
            <option value="quantity">Por cantidad</option>
            <option value="frequency">Por frecuencia</option>
          </select>
        </h3>
        <div class="chart-wrapper">
          <canvas id="topProductsChart"></canvas>
        </div>
      </div>
      
      <!-- Product Table -->
      <div class="chart-container">
        <h3>ğŸ“¦ Todos los Productos 
          <span class="badge badge-primary" id="productCountBadge">0 productos</span>
        </h3>
        <div id="productTable">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>

    </section>

    <!-- ==================== PRICE HISTORY TAB ==================== -->
    <section id="pricesTab" class="tab-content">
      
      <!-- Price Summary Cards -->
      <div class="stats-grid" id="priceSummaryCards">
        <!-- Will be populated by JS -->
      </div>

      <!-- General Price Trend Chart -->
      <div class="chart-container">
        <h3>ğŸ“Š Tendencia General de Precios</h3>
        <p class="chart-subtitle">VariaciÃ³n media de precios en el perÃ­odo seleccionado</p>
        <div class="chart-wrapper">
          <canvas id="generalPriceTrendChart"></canvas>
        </div>
      </div>

      <!-- Individual Price Evolution Chart -->
      <div class="chart-container">
        <h3>ğŸ“ˆ EvoluciÃ³n Individual
          <select id="productPriceSelect" class="inline-select"></select>
        </h3>
        <div id="individualPriceChart" class="chart-wrapper">
          <p style="text-align: center; color: var(--text-muted); padding: 40px;">Selecciona un producto para ver su evoluciÃ³n de precio</p>
        </div>
      </div>
      
      <!-- Price Changes Table -->
      <div class="chart-container">
        <h3>ğŸ’¹ VariaciÃ³n de Precios
          <select id="priceSort" class="inline-select">
            <option value="variation">Mayor variaciÃ³n</option>
            <option value="increase">Mayor subida</option>
            <option value="decrease">Mayor bajada</option>
          </select>
        </h3>
        <div id="priceChangeTable">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>

    </section>

    <!-- ==================== TICKETS TAB ==================== -->
    <section id="ticketsTab" class="tab-content">

      <!-- Ticket Stats -->
      <div id="ticketsStats" class="stats-grid"></div>

      <!-- Ticket List Controls -->
      <div class="chart-container">
        <h3>ğŸ§¾ Historial de Tickets
          <select id="ticketSort" class="inline-select">
            <option value="date-desc">MÃ¡s recientes</option>
            <option value="date-asc">MÃ¡s antiguos</option>
            <option value="total-desc">Mayor importe</option>
            <option value="total-asc">Menor importe</option>
            <option value="items-desc">MÃ¡s productos</option>
          </select>
          <input type="text" id="ticketSearch" placeholder="Buscar ticket..." class="inline-input">
          <select id="ticketsPerPage" class="inline-select">
            <option value="10">10/pÃ¡gina</option>
            <option value="20">20/pÃ¡gina</option>
            <option value="50">50/pÃ¡gina</option>
          </select>
        </h3>
        <div id="ticketListContainer" class="ticket-list">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- Ticket Detail Modal -->
      <div id="ticketModal" class="modal">
        <div class="modal-content" id="ticketModalContent">
        </div>
      </div>

    </section>

    <!-- ==================== INSIGHTS TAB ==================== -->
    <section id="insightsTab" class="tab-content">
      
      <!-- Price Alerts -->
      <div class="chart-container">
        <h3>ğŸš¨ Alertas de Precio</h3>
        <p class="chart-subtitle">Productos con cambios de precio significativos</p>
        <div id="priceAlerts"></div>
      </div>

      <!-- Spending Prediction -->
      <div class="chart-container">
        <h3>ğŸ”® PredicciÃ³n de Gasto</h3>
        <div id="predictions" class="prediction-box"></div>
      </div>

      <!-- Shopping Habits -->
      <div class="chart-container">
        <h3>ğŸ§  HÃ¡bitos de Compra</h3>
        <div id="shoppingHabits"></div>
      </div>

      <!-- Budget Tracker -->
      <div class="chart-container">
        <h3>ğŸ’³ Control de Presupuesto</h3>
        <div id="budgetTracker"></div>
      </div>

      <!-- Shopping Patterns -->
      <div class="chart-container">
        <h3>ğŸ“Š Patrones de Compra</h3>
        <div id="shoppingPatterns"></div>
      </div>

      <!-- Savings Opportunities -->
      <div class="chart-container">
        <h3>ğŸ’¡ Oportunidades de Ahorro</h3>
        <div id="savingsOpportunities"></div>
      </div>

    </section>

  </div>

  <!-- Data Loader Modal -->
  <div id="dataLoaderModal" class="modal data-loader-modal">
    <div class="modal-content data-loader-content">
      <div class="modal-header">
        <h2>ğŸ›’ Cargar Datos de Mercadona</h2>
      </div>
      <div class="modal-body">
        <p class="modal-intro">No se encontrÃ³ ningÃºn archivo de datos. Puedes cargar tus tickets de dos formas:</p>
        
        <div class="loader-options">
          <!-- Option 1: JSON File -->
          <div class="loader-option">
            <h3>ğŸ“„ Cargar archivo JSON</h3>
            <p>Si ya tienes un archivo <code>tickets.json</code> generado anteriormente:</p>
            <div id="jsonDropzone" class="dropzone">
              <div class="dropzone-content">
                <span class="dropzone-icon">ğŸ“</span>
                <p>Arrastra tu archivo JSON aquÃ­</p>
                <p class="text-muted">o haz clic para seleccionar</p>
              </div>
              <input type="file" id="jsonFileInput" accept=".json" hidden>
            </div>
            <div id="jsonStatus" class="status-message"></div>
          </div>
          
          <div class="loader-divider">
            <span>o</span>
          </div>
          
          <!-- Option 2: PDF Files -->
          <div class="loader-option">
            <h3>ğŸ“‘ Cargar tickets en PDF</h3>
            <p>Sube los PDFs de tus tickets de Mercadona para procesarlos:</p>
            <div id="pdfDropzone" class="dropzone">
              <div class="dropzone-content">
                <span class="dropzone-icon">ğŸ“„</span>
                <p>Arrastra tus PDFs aquÃ­</p>
                <p class="text-muted">o haz clic para seleccionar (mÃºltiples archivos)</p>
              </div>
              <input type="file" id="pdfFileInput" accept=".pdf" multiple hidden>
            </div>
            <div id="pdfFileList" class="file-list-container">
              <p class="text-muted">No hay archivos seleccionados</p>
            </div>
            <button id="processPdfsBtn" class="btn btn-primary" disabled>
              ğŸš€ Procesar PDFs
            </button>
            <div id="pdfProgress" class="progress-container" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>ğŸ“Š Dashboard de estadÃ­sticas de compras en Mercadona</p>
    <p>Datos extraÃ­dos de tickets digitales</p>
  </footer>

  <!-- PDF.js for PDF parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>

  <!-- JS Modules -->
  <script src="js/utils.js"></script>
  <script src="js/charts.js"></script>
  <script src="js/parser.js"></script>
  <script src="js/tabs/overview.js"></script>
  <script src="js/tabs/categories.js"></script>
  <script src="js/tabs/products.js"></script>
  <script src="js/tabs/prices.js"></script>
  <script src="js/tabs/tickets.js"></script>
  <script src="js/tabs/insights.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
