<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estadísticas de Compras</title>

  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- CSS Modules -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/themes.css">

  <!-- Tab-specific CSS -->
  <link rel="stylesheet" href="css/tabs/shared.css">
  <link rel="stylesheet" href="css/tabs/insights.css">
  <link rel="stylesheet" href="css/tabs/products.css">
  <link rel="stylesheet" href="css/tabs/prices.css">
  <link rel="stylesheet" href="css/tabs/tickets.css">
  <link rel="stylesheet" href="css/tabs/categories.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <div class="container">

    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1><span class="logo"></span>Estadísticas compras</h1>
        <p id="periodInfo">Cargando...</p>
      </div>
      <div class="filters">
        <div class="filter-group">
          <label for="storeFilter">Tienda:</label>
          <select id="storeFilter">
            <option value="all">Todas las tiendas</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="yearFilter">Año:</label>
          <select id="yearFilter">
            <option value="all">Todos los años</option>
          </select>
        </div>
        <button class="icon-btn" id="downloadBtn" onclick="downloadGeneratedJSON()"
          title="Descargar tickets.json">⬇</button>
        <button class="icon-btn" id="addDataBtn" onclick="showDataLoaderModal()" title="Añadir más tickets">+</button>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="tabs">
      <button class="tab-btn active" data-tab="overview">
        Resumen
      </button>
      <button class="tab-btn" data-tab="insights">
        Insights
      </button>
      <button class="tab-btn" data-tab="categories">
        Categorías
      </button>
      <button class="tab-btn" data-tab="products">
        Productos
      </button>
      <button class="tab-btn" data-tab="prices">
        Precios
      </button>
      <button class="tab-btn" data-tab="tickets">
        Tickets
      </button>
    </nav>

    <!-- ==================== OVERVIEW TAB ==================== -->
    <section id="overviewTab" class="tab-content active">

      <!-- Stats Cards -->
      <div class="grid">
        <div class="card">
          <h3>Total Gastado</h3>
          <div class="value blue" id="totalSpent">-</div>
          <div class="subtitle" id="totalSpentPeriod"></div>
        </div>
        <div class="card">
          <h3>Total Tickets</h3>
          <div class="value green" id="ticketCount">-</div>
          <div class="subtitle" id="avgDaysBetween"></div>
        </div>
        <div class="card">
          <h3>Media por Ticket</h3>
          <div class="value purple" id="avgTicket">-</div>
          <div class="subtitle" id="ticketRange"></div>
        </div>
        <div class="card">
          <h3>Media Mensual</h3>
          <div class="value orange" id="avgMonth">-</div>
          <div class="subtitle" id="monthComparison"></div>
        </div>
        <div class="card">
          <h3>Tienda más visitada</h3>
          <div class="value" id="topStore">-</div>
          <div class="subtitle" id="topStoreCount"></div>
        </div>
        <div class="card">
          <h3>Día favorito</h3>
          <div class="value" id="favoriteDay">-</div>
          <div class="subtitle" id="favoriteDayCount"></div>
        </div>
      </div>

      <!-- Comparison Cards -->
      <div class="comparison-section" id="comparisonSection">
        <h3>Comparativa con período anterior</h3>
        <div class="grid grid-3" id="comparisonCards"></div>
      </div>

      <!-- Monthly Chart -->
      <div class="chart-container">
        <h3>Gasto por Mes</h3>
        <div class="chart-wrapper">
          <canvas id="monthlyChart"></canvas>
        </div>
        <div id="monthlySummary"></div>
      </div>

      <!-- Weekly Pattern -->
      <div class="chart-container">
        <h3>Patrón Semanal de Compras</h3>
        <div class="chart-wrapper small">
          <canvas id="weeklyChart"></canvas>
        </div>
      </div>

    </section>

    <!-- ==================== CATEGORIES TAB ==================== -->
    <section id="categoriesTab" class="tab-content">

      <div class="grid grid-2">
        <!-- Category Chart -->
        <div class="chart-container">
          <h3>Distribución por Categoría</h3>
          <div class="chart-wrapper">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>

        <!-- Category List -->
        <div class="chart-container">
          <h3>Detalle por Categoría</h3>
          <div class="category-list" id="categoryList">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Monthly Category Chart -->
      <div class="chart-container">
        <h3>Gasto por Mes y Categoría</h3>
        <div class="chart-wrapper" style="height: 400px;">
          <canvas id="categoryMonthlyChart"></canvas>
        </div>
      </div>

      <!-- Products by Category -->
      <div class="chart-container">
        <h3>Productos por Categoría
          <select id="categoryProductFilter" class="inline-select">
            <option value="all">Todas las categorías</option>
          </select>
          <select id="monthProductFilter" class="inline-select">
            <option value="all">Todos los meses</option>
          </select>
        </h3>
        <div id="categoryProductList">
          <div class="loading">
            <div class="spinner"></div>
          </div>
        </div>
      </div>

    </section>

    <!-- ==================== PRODUCTS TAB ==================== -->
    <section id="productsTab" class="tab-content">

      <!-- Search -->
      <div class="chart-container">
        <h3>Buscar Producto</h3>
        <div class="search-box">
          <input type="text" id="productSearch" placeholder="Buscar producto...">
        </div>
        <div id="searchResults" class="product-list"></div>
      </div>

      <!-- Top Products Chart -->
      <div class="chart-container">
        <h3>Top 10 Productos por Gasto
          <select id="topProductsSort" class="inline-select">
            <option value="spent">Por gasto total</option>
            <option value="quantity">Por cantidad</option>
            <option value="frequency">Por frecuencia</option>
          </select>
        </h3>
        <div class="chart-wrapper">
          <canvas id="topProductsChart"></canvas>
        </div>
      </div>

      <!-- Product Table -->
      <div class="chart-container">
        <h3>Todos los Productos
          <span class="badge badge-primary" id="productCountBadge">0 productos</span>
          <button class="btn-small" id="manageAliasesBtn" style="float: right; margin-left: auto;">Gestionar
            Agrupaciones (Alias)</button>
        </h3>
        <div id="productTable">
          <div class="loading">
            <div class="spinner"></div>
          </div>
        </div>
      </div>

    </section>

    <!-- Product Grouping Modal -->
    <div id="groupingModal" class="modal">
      <div class="modal-content" style="max-width: 900px; display: flex; flex-direction: column; height: 90vh;">
        <div class="modal-header"
          style="margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="font-size: 1.25rem; font-weight: 700;">Agrupación de Productos (Alias)</h2>
          <span class="modal-close" id="closeGroupingModalBtn">&times;</span>
        </div>

        <div class="modal-body" style="flex: 1; overflow-y: auto; display: flex; gap: 20px;">
          <!-- Left: Unmapped Products -->
          <div class="col" style="flex: 1; display: flex; flex-direction: column;">
            <h4 style="margin-bottom: 10px;">Productos Sin Agrupar
              <button class="btn-small" id="autoSuggestBtn"
                style="font-size: 0.7rem; float: right; background: var(--info);">✨ Auto-Detectar</button>
            </h4>
            <input type="text" id="groupingSearch" placeholder="Filtrar productos..." class="search-input"
              style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 4px;">
            <div id="unmappedList"
              style="flex: 1; border: 1px solid var(--border-color); border-radius: 4px; overflow-y: auto; padding: 5px; height: 300px;">
            </div>
            <div style="margin-top: 5px; font-size: 0.8rem; color: var(--text-muted);">Selecciona productos para
              vincular</div>
          </div>

          <!-- Middle: Actions -->
          <div class="col"
            style="width: 60px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px;">
            <button id="linkProductsBtn" class="icon-btn" title="Vincular selección" disabled>→</button>
          </div>

          <!-- Right: Canonical Groups -->
          <div class="col" style="flex: 1; display: flex; flex-direction: column;">
            <h4 style="margin-bottom: 10px;">Grupos (Nombres Canónicos)
              <button class="btn-small" id="newGroupBtn"
                style="font-size: 0.7rem; float: right; background: var(--success);">+ Nuevo Grupo</button>
            </h4>
            <div id="canonicalList"
              style="flex: 1; border: 1px solid var(--border-color); border-radius: 4px; overflow-y: auto; padding: 5px; height: 300px;">
            </div>
          </div>
        </div>

        <!-- Footer / Editor -->
        <div class="modal-footer" id="groupEditor"
          style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 15px; display: none;">
          <h4 style="margin-bottom: 10px;">Editando Grupo</h4>
          <div style="display: flex; gap: 10px; align-items: flex-end;">
            <div style="flex: 1;">
              <label style="display: block; font-size: 0.8rem; margin-bottom: 4px;">Nombre Canónico (Ej: Leche
                Semidesnatada)</label>
              <input type="text" id="canonicalNameInput"
                style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
            </div>
            <button class="btn-small" id="saveGroupBtn">Guardar Grupo</button>
            <button class="btn-small" id="cancelGroupBtn" style="background: var(--text-muted);">Cancelar</button>
          </div>
          <div style="margin-top: 10px;">
            <label style="display: block; font-size: 0.8rem; margin-bottom: 4px;">Productos Vinculados:</label>
            <div id="linkedProductsList" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
          </div>
        </div>

        <!-- Auto Suggest Results -->
        <div class="modal-footer" id="autoSuggestPanel"
          style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 15px; display: none; max-height: 200px; overflow-y: auto;">
          <h4 style="margin-bottom: 10px;">Sugerencias Encontradas <span id="suggestionCount" class="badge">0</span>
          </h4>
          <table style="width: 100%; text-align: left; font-size: 0.85rem;">
            <thead>
              <tr>
                <th>Nombre A</th>
                <th>Nombre B</th>
                <th>Similitud</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody id="suggestionsTableBody"></tbody>
          </table>
          <button class="btn-small" id="closeSuggestBtn" style="margin-top: 10px; background: var(--text-muted);">Cerrar
            Sugerencias</button>
        </div>
      </div>
    </div>

    <!-- ==================== PRICE HISTORY TAB ==================== -->
    <section id="pricesTab" class="tab-content">

      <!-- Price Summary Cards -->
      <div class="stats-grid" id="priceSummaryCards">
        <!-- Will be populated by JS -->
      </div>

      <!-- General Price Trend Chart -->
      <div class="chart-container">
        <h3>Tendencia General de Precios</h3>
        <p class="chart-subtitle">Variación media de precios en el período seleccionado</p>
        <div class="chart-wrapper">
          <canvas id="generalPriceTrendChart"></canvas>
        </div>
      </div>

      <!-- Individual Price Evolution Chart -->
      <div class="chart-container">
        <h3>Evolución Individual
          <select id="productPriceSelect" class="inline-select"></select>
          </select>
        </h3>
        <div id="individualPriceChart" class="chart-wrapper">
          <p style="text-align: center; color: var(--text-muted); padding: 40px;">Selecciona un producto para ver su
            evolución de precio</p>
        </div>
      </div>

      <!-- Price Comparison -->
      <div class="chart-container">
        <h3>Comparador de Productos (Selección Manual)</h3>
        <p class="chart-subtitle">Selecciona tienda y producto para añadirlos a la tabla comparativa</p>

        <div class="comparison-controls"
          style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; background: var(--bg-main); padding: 15px; border-radius: var(--border-radius-sm);">
          <div class="control-group">
            <label for="compStoreSelect"
              style="font-size: 0.8rem; display: block; margin-bottom: 4px; color: var(--text-secondary);">1.
              Tienda</label>
            <select id="compStoreSelect" class="inline-select" style="margin: 0; min-width: 150px;">
              <option value="">Cargando...</option>
            </select>
          </div>

          <div class="control-group">
            <label for="compProductSelect"
              style="font-size: 0.8rem; display: block; margin-bottom: 4px; color: var(--text-secondary);">2.
              Producto</label>
            <select id="compProductSelect" class="inline-select" style="margin: 0; min-width: 250px;" disabled>
              <option value="">Selecciona tienda primero</option>
            </select>
          </div>

          <div class="control-group" style="display: flex; align-items: flex-end; height: 100%;">
            <button id="addCompBtn" class="btn-small" style="margin-top: 20px;" disabled>+ Añadir</button>
            <button id="clearCompBtn" class="btn-small"
              style="margin-top: 20px; margin-left: 10px; background: var(--text-muted); display: none;">Limpiar</button>
          </div>
        </div>

        <div id="priceComparisonContainer">
          <div class="empty-state"
            style="text-align: center; color: var(--text-muted); padding: 30px; border: 2px dashed var(--border-color); border-radius: var(--border-radius);">
            <div style="font-size: 2rem; margin-bottom: 10px;">⚖️</div>
            <p>Añade productos de diferentes tiendas para comparar sus precios lado a lado</p>
          </div>
        </div>
      </div>

      <!-- Price Changes Table -->
      <div class="chart-container">
        <h3>Variación de Precios
          <select id="priceSort" class="inline-select">
            <option value="variation">Mayor variación</option>
            <option value="increase">Mayor subida</option>
            <option value="decrease">Mayor bajada</option>
          </select>
        </h3>
        <div id="priceChangeTable">
          <div class="loading">
            <div class="spinner"></div>
          </div>
        </div>
      </div>

    </section>

    <!-- ==================== TICKETS TAB ==================== -->
    <section id="ticketsTab" class="tab-content">

      <!-- Ticket Stats -->
      <div id="ticketsStats" class="stats-grid"></div>

      <!-- Ticket List Controls -->
      <div class="chart-container">
        <h3>Historial de Tickets
          <select id="ticketSort" class="inline-select">
            <option value="date-desc">Más recientes</option>
            <option value="date-asc">Más antiguos</option>
            <option value="total-desc">Mayor importe</option>
            <option value="total-asc">Menor importe</option>
            <option value="items-desc">Más productos</option>
          </select>
          <input type="text" id="ticketSearch" placeholder="Buscar ticket..." class="inline-input">
          <select id="ticketsPerPage" class="inline-select">
            <option value="10">10/página</option>
            <option value="20">20/página</option>
            <option value="50">50/página</option>
          </select>
        </h3>
        <div id="ticketListContainer" class="ticket-list">
          <div class="loading">
            <div class="spinner"></div>
          </div>
        </div>
      </div>

      <!-- Ticket Detail Modal -->
      <div id="ticketModal" class="modal">
        <div class="modal-content" id="ticketModalContent">
        </div>
      </div>

    </section>

    <!-- ==================== INSIGHTS TAB ==================== -->
    <section id="insightsTab" class="tab-content">
      <div class="insights-dashboard">
        <!-- Top Row -->
        <div class="insight-card price-alerts-card">
          <h3>Alertas de Precios Importantes</h3>
          <div id="priceAlertsList" class="alerts-container"></div>
        </div>

        <!-- Middle Row -->
        <div class="insight-card habits-card">
          <h3>Hábitos de Compra</h3>
          <div class="habits-container">
            <div class="habit-box">
              <span class="habit-label">Momento Favorito</span>
              <div class="habit-value-row">
                <span id="favDay">Viernes</span>
              </div>
              <div class="habit-value-row">
                <span id="favTime">18:00 - 19:00</span>
              </div>
            </div>
            <div class="habit-box">
              <span class="habit-label">Intervalo Medio entre Compras</span>
              <div class="habit-big-value">
                <span id="avgInterval">7.5</span> <span class="unit">Días</span>
              </div>
              <div class="habit-trend">
                <span id="intervalTrend">Similar al mes pasado</span>
              </div>
            </div>
          </div>
        </div>

        <div class="insight-card heatmap-card">
          <h3>Patrones de Compra (Mapa de Calor)</h3>
          <div class="heatmap-wrapper">
            <div class="heatmap-labels-y">
              <span>Lun</span><span>Mar</span><span>Mié</span><span>Jue</span><span>Vie</span><span>Sáb</span><span>Dom</span>
            </div>
            <div id="heatmapGrid" class="heatmap-grid"></div>
            <div class="heatmap-labels-x">
              <span>8h</span><span>9h</span><span>10h</span><span>11h</span><span>12h</span><span>13h</span><span>14h</span><span>15h</span><span>16h</span><span>17h</span><span>18h</span><span>19h</span><span>20h</span><span>21h</span><span>22h</span>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- Data Loader Modal -->
  <div id="dataLoaderModal" class="modal data-loader-modal">
    <div class="modal-content data-loader-content">
      <div class="modal-header">
        <h2>Cargar Datos de Mercadona</h2>
        <button id="closeModalBtn" class="modal-close-btn" title="Cerrar">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-intro">No se encontró ningún archivo de datos. Puedes cargar tus tickets de dos formas:</p>

        <div class="loader-options">
          <!-- Option 1: JSON File -->
          <div class="loader-option">
            <h3>Cargar archivo JSON</h3>
            <p>Si ya tienes un archivo <code>tickets.json</code> generado anteriormente:</p>
            <div id="jsonDropzone" class="dropzone">
              <div class="dropzone-content">
                <span class="dropzone-icon">↓</span>
                <p>Arrastra tu archivo JSON aquí</p>
                <p class="text-muted">o haz clic para seleccionar</p>
              </div>
              <input type="file" id="jsonFileInput" accept=".json" hidden>
            </div>
            <div id="jsonStatus" class="status-message"></div>
            <div id="jsonWarning" class="json-warning" style="display: none;">
              <p class="warning-text"></p>
              <button id="jsonConfirmBtn" class="btn btn-danger">Aceptar y reemplazar</button>
            </div>
          </div>

          <div class="loader-divider">
            <span>o</span>
          </div>

          <!-- Option 2: Files (PDF/Images) -->
          <div class="loader-option">
            <h3>Cargar tickets (PDF/Imagen)</h3>
            <p>Sube tus tickets de Mercadona (PDF) o Lidl (Imagen) para procesarlos:</p>
            <div id="pdfDropzone" class="dropzone">
              <div class="dropzone-content">
                <span class="dropzone-icon">↓</span>
                <p>Arrastra tus archivos aquí</p>
                <p class="text-muted">o haz clic para seleccionar (PDF, JPG, PNG)</p>
              </div>
              <input type="file" id="pdfFileInput" accept=".pdf, .jpg, .jpeg, .png" multiple hidden>
            </div>
            <div id="pdfFileList" class="file-list-container">
              <p class="text-muted">No hay archivos seleccionados</p>
            </div>
            <button id="processPdfsBtn" class="btn btn-primary" disabled>
              Procesar Tickets
            </button>
            <div id="pdfProgress" class="progress-container" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>Dashboard de estadísticas de compras en Mercadona</p>
    <p>Datos extraídos de tickets digitales</p>
  </footer>

  <!-- PDF.js for PDF parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>

  <!-- Tesseract.js for Image OCR -->
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

  <!-- JS Modules -->
  <script src="js/utils.js"></script>
  <script src="js/charts.js"></script>
  <script src="js/parser.js"></script>
  <script src="js/nutrition.js"></script>
  <script src="js/tabs/overview.js"></script>
  <script src="js/tabs/categories.js"></script>
  <script src="js/tabs/products.js"></script>
  <script src="js/tabs/prices.js"></script>
  <script src="js/tabs/tickets.js"></script>
  <script src="js/tabs/insights.js"></script>
  <script src="js/app.js"></script>
</body>

</html>